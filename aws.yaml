- resource: https://<API-ID>.execute-api.<REGION>.amazonaws.com/billing
  method: POST
  headers:
    Content-Type: application/json
  payload: '{"metric": "UnblendedRateCalc"}'
  scan_interval: 7200
  sensor:
    - name: "AWS Billing Month Spend"
      unique_id: 7482f4aee38a4b492c31b2df93d3f80adaf96c1d
      value_template: "{{ value_json.total_spend }}"
      unit_of_measurement: "USD"

    - name: "AWS Billing Last Day Spend"
      unique_id: 2c96d95c4e7624619e3ac22a859fe0745447ef73
      value_template: "{{ value_json.last_day_spend }}"
      unit_of_measurement: "USD"

    - name: "AWS Billing Latest Day"
      unique_id: 130f8ce407ae4241fc701080f5dd10e4aeac2a49
      value_template: >
        {% set raw_date = value_json.latest_day | default("") %}
        {% if raw_date | length == 10 %}
          {% set year = raw_date[0:4] %}
          {% set month = raw_date[5:7] %}
          {% set day = raw_date[8:10] %}
          {{ (year ~ '-' ~ month ~ '-' ~ day ~ 'T00:00:00Z') | as_datetime }}
        {% else %}
          unavailable
        {% endif %}
      device_class: date
      availability: >
        {{ value_json.latest_day | default("") | length == 10 }}

    - name: "AWS Billing Metric Used"
      unique_id: daf25c89da37d68aae626fcf17e37d5421a79f98
      value_template: "{{ value_json.metric_used }}"

    - name: "AWS Billing Report Timestamp"
      unique_id: bc0b6cbc89f569a909cff415c9afb4b99655ad5a
      value_template: >
        {% set raw_timestamp = value_json.report_timestamp | default("") %}
        {% if raw_timestamp | length == 16 %}
          {% set year = raw_timestamp[0:4] %}
          {% set month = raw_timestamp[4:6] %}
          {% set day = raw_timestamp[6:8] %}
          {% set hour = raw_timestamp[9:11] %}
          {% set minute = raw_timestamp[11:13] %}
          {% set second = raw_timestamp[13:15] %}
          {{ (year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':' + second + 'Z') | as_datetime }}
        {% else %}
          unavailable
        {% endif %}
      device_class: timestamp
      availability: >
        {{ value_json.report_timestamp | default("") | length == 16 }}

    - name: "AWS Billing Message"
      unique_id: 84fc8668541ac51bd2cd6ffea894871832b4d324
      value_template: "{{ value_json.message }}"

    - name: "AWS Billing Bubble info"
      unique_id: 1b5604a1669e24b260b1d1a09b83393fa8d59964
      value_template: "${{ value_json.total_spend }} (${{ value_json.last_day_spend }})"
